   
<body onload="onLoad();" style="
margin: 0px;
overflow: hidden;
height: 100%;
width: 100%;
background-size: 100%;">

<script src='./js/thirdparty/jquery-3.3.1.min.js'></script>
<script src='./js/thirdparty/codemirror/codemirror.js'></script>
<script src='./js/thirdparty/codemirror/codemirror.css.js'></script>
<script src='./js/thirdparty/codemirror/clike.js'></script>
<script src='./js/thirdparty/three/three.min.js'></script>
<script src='./js/thirdparty/three/libs/stats.min.js'></script>
<script src='./js/thirdparty/three/libs/dat.gui.min.js'></script>
<script src='./js/thirdparty/three/controls/OrbitControls.js'></script>
<script src='./js/gl.js'></script>
<script src='./js/gui.js'></script>
<script src='./js/shaders.js'></script>
<script src='./js/raytracer.js'></script>
<script src='./js/fibre.js'></script>


<?/* ------------------------------------------------------------------*/?>
<?/*                            main loop                              */?>
<?/* ------------------------------------------------------------------*/?>


<div id='container' style='
position: relative;
margin: 0px;
padding: 0px;
'>

<div id='gui' style='
position:absolute;
z-index:2;
'></div>

<button id='toggle-code-button' style='
position:absolute;
z-index:2;
border:none;
top: 0px;
margin-left:5px;
padding:8;
outline:0;
width: 10px;
height: 10px;
box-shadow:none!important;
background:none;
color:rgb(216, 155, 63);
font-size:24px;
'>â˜°</button>

<textarea id="textarea-code" name="textarea-code"> 
</textarea>

<textarea id="textarea-errors" name="textarea-errors"> 
</textarea>


<div style='position:relative;'>

<canvas id='render-canvas' style='
position:absolute;
left: 0; top: 0;
height: 100%;
width: 100%;
z-index:-1;
'></canvas>

<canvas id='text-canvas' style='
position:relative;
left: 0; top: 0;
height: 100%;
width: 100%;
z-index:0;
pointer-events: none;  
'></canvas>

</div>
</div>


<script type="text/javascript">

function onLoad() 
{ 
    let canvas = document.getElementById("render-canvas");
    GLU.setupGL(canvas);
    gl = GLU.gl;

    var styleElement = document.createElement('style');
    styleElement.appendChild(document.createTextNode(codemirror_css_rules));
    document.getElementsByTagName('head')[0].appendChild(styleElement);

    let code_textarea = document.getElementById("textarea-code");
    let editor = CodeMirror(function(elt) {
        code_textarea.parentNode.replaceChild(elt, code_textarea);
    }, {
        lineNumbers: true,
        extraKeys: {"Ctrl-Space": "autocomplete"},
        mode: "x-shader/x-fragment"
    });
    editor.setOption("theme", 'lucario');

    let error_textarea = document.getElementById("textarea-errors");
    let error_editor = CodeMirror(function(elt) {
        error_textarea.parentNode.replaceChild(elt, error_textarea);
    }, {
        lineNumbers: false,
        extraKeys: {"Ctrl-Space": "autocomplete"},
        viewportMargin: Infinity,
        mode: "x-shader/x-fragment",
        readOnly: true
    });
    error_editor.setOption("theme", 'monokai');
    error_editor.setValue('test');

    this.code = `
///////////////////////////////////////////
// Lorenz attractor
///////////////////////////////////////////

const float rho = 8.0;      // auto-creates a float slider, driving this parameter
const float sigma = 1.0;
const float beta = 8.0/3.0;

const vec3 colA = vec3(1, 0, 1);
const vec3 colB = vec3(1, 1, 0);
const float wavelength = 0.1;

vec3 velocity(vec3 p, float t)
{
    vec3 v;
    float x = p.x;
    float y = p.y;
    float z = p.z;
    v.x = sigma*(y - x);
    v.y = x*(rho - z);
    v.z = x*y - beta*z;
    return v;
}    

vec3 color(vec3 p, float t)
{
    float phase = cos(t/wavelength);
    return cos(phase)*colA + sin(phase)*colB;
}  
`;

    editor.setValue(this.code);

    fibre = new Fibre(editor, error_editor); 

    var cmEl = document.querySelector('.CodeMirror');

    cmEl.addEventListener('mouseleave', function(e) {
        console.log('mouseleave');
        if (!fibre.cornerDragging && !fibre.centerDragging)
            fibre.camControls.enabled = true;
    });

    cmEl.addEventListener('mouseenter', function(e) {
        console.log('mouseenter');
        fibre.camControls.enabled = false;
    });

    animateLoop(); 
}

function animateLoop() 
{ 
    fibre.render(); 
    window.requestAnimationFrame(animateLoop); 
}


$(document).ready(function()
{
    $('#div-code').hide();

    $("#toggle-code-button").click(function(){

        $('.CodeMirror').fadeToggle(1000);
        console.log('helo');
    });
});

</script>

</body>
